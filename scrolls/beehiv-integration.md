# Codex Scroll: Beehiv Newsletter Integration

**id:** scroll-beehiv-integration
**status:** active
**version:** 1.0.0
**last_updated:** 2025-10-30

---

## Overview

The Beehiv integration connects the Beehive advertising platform with Beehiv's newsletter platform, enabling:
- **Newsletter distribution** of AI-generated creative content
- **Subscriber management** synchronized with campaign metrics
- **Campaign performance** tracking across email and social channels
- **Sentiment-aware newsletters** generated by the Viral Forge

---

## Architecture

### Components

1. **Beehiv API Client** (`src/lib/beehiv.ts`)
   - Core API wrapper for Beehiv v2 API
   - Handles authentication, subscriptions, posts, and analytics
   - Singleton pattern for server-side use

2. **Netlify Sync Function** (`netlify/functions/beehiv-sync.ts`)
   - Webhook handler for Beehiv events
   - Campaign sending endpoint
   - Stats and publication info retrieval

3. **Next.js API Route** (`pages/api/beehiv/subscribe.ts`)
   - Public-facing subscription endpoint
   - UTM tracking and custom field support
   - User-agent and referrer capture

4. **Environment Guards** (`src/lib/envGuard.ts`)
   - `assertBeehivEnv()` validates required credentials

---

## Setup

### 1. Environment Variables

Add to `.env.local` or Netlify environment:

```bash
BEEHIV_API_KEY=your_api_key_here
BEEHIV_PUBLICATION_ID=your_publication_id
```

Get these from:
- Beehiv Dashboard → Settings → API
- Publication ID from your publication's settings

### 2. Database Schema

Create Supabase tables for tracking:

```sql
-- Newsletter subscribers
CREATE TABLE newsletter_subscribers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  publication_id TEXT,
  status TEXT,
  subscribed_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Newsletter campaigns
CREATE TABLE newsletter_campaigns (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  campaign_id TEXT,
  sentiment TEXT,
  tags TEXT[],
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  beehiv_post_id TEXT,
  opens INT DEFAULT 0,
  clicks INT DEFAULT 0,
  unique_opens INT DEFAULT 0
);

-- Create indexes
CREATE INDEX idx_subscribers_email ON newsletter_subscribers(email);
CREATE INDEX idx_campaigns_campaign_id ON newsletter_campaigns(campaign_id);
CREATE INDEX idx_campaigns_sent_at ON newsletter_campaigns(sent_at DESC);
```

### 3. Webhook Configuration

In Beehiv Dashboard → Settings → Webhooks:

1. Add webhook URL: `https://yoursite.netlify.app/.netlify/functions/beehiv-sync/webhook`
2. Subscribe to events:
   - `subscription.created`
   - `subscription.updated`
   - `subscription.deleted`
3. (Optional) Configure webhook secret for signature verification

---

## Usage

### Subscribe Users

```typescript
import { subscribeToNewsletter } from '@/lib/beehiv';

// Simple subscription
await subscribeToNewsletter('user@example.com');

// With metadata
await subscribeToNewsletter('user@example.com', {
  interest: 'marketing',
  utm_source: 'campaign-123',
});
```

### Send Campaign Newsletter

```typescript
import { sendNewsletterCampaign } from '@/lib/beehiv';

await sendNewsletterCampaign({
  title: 'Weekly Campaign Update',
  content: '<h1>Latest Insights</h1><p>Your creative is performing...</p>',
  sentiment: 'positive',
  campaignId: 'campaign-123',
});
```

### Frontend Integration

```typescript
// Subscribe form handler
async function handleSubscribe(email: string) {
  const res = await fetch('/api/beehiv/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email,
      utmSource: 'homepage',
      customFields: { segment: 'early-adopter' },
    }),
  });

  const data = await res.json();
  if (data.success) {
    console.log('Subscribed!', data);
  }
}
```

### Advanced: Beehiv Client Usage

```typescript
import { BeehivClient } from '@/lib/beehiv';

const client = new BeehivClient();

// Get publication stats
const stats = await client.getStats();
console.log(`Total subscribers: ${stats.total_subscribers}`);

// Create a draft post
await client.createPost({
  title: 'New Campaign Insights',
  content_html: '<p>Content here...</p>',
  status: 'draft',
  audience: 'free',
});

// Get subscriber details
const subscriber = await client.getSubscriber('user@example.com');
console.log(subscriber.status); // 'active' | 'inactive'

// Update subscriber
await client.updateSubscriber('user@example.com', {
  custom_fields: { vip: true },
});
```

---

## Integration Points

### With Viral Forge

The Viral Forge can automatically generate and send newsletters:

```typescript
// Generate sentiment-aware content
const content = await runGeminiPrompt(
  'Generate newsletter for positive sentiment campaign',
  `Campaign: ${campaignData}`
);

// Send via Beehiv
await sendNewsletterCampaign({
  title: 'Your Campaign is Trending!',
  content,
  sentiment: 'positive',
  campaignId: campaign.id,
});
```

### With Campaign Orchestration

Track newsletter as a distribution channel:

```typescript
// After sending campaign update
await supabaseAdmin.from('campaign_channels').insert({
  campaign_id: 'campaign-123',
  channel: 'newsletter',
  platform: 'beehiv',
  reach: stats.total_subscribers,
  engagement: stats.open_rate,
});
```

### With K-Factor Tracking

Track newsletter referrals:

```typescript
// Subscribe with referral tracking
await subscribeToNewsletter(email, {
  utm_source: 'referral',
  utm_campaign: referringCampaignId,
  referrer_email: referrerEmail,
});

// Calculate K-factor contribution
const newsletterKFactor = (referrals / totalSubscribers);
```

---

## API Reference

### BeehivClient Methods

| Method | Description | Returns |
|--------|-------------|---------|
| `subscribe(subscriber)` | Add new subscriber | `Promise<any>` |
| `getSubscriber(email)` | Get subscriber details | `Promise<any>` |
| `updateSubscriber(email, updates)` | Update subscriber | `Promise<any>` |
| `unsubscribe(email)` | Remove subscriber | `Promise<any>` |
| `createPost(post)` | Create newsletter post | `Promise<any>` |
| `getPublication()` | Get publication info | `Promise<BeehivPublication>` |
| `getStats()` | Get publication stats | `Promise<any>` |
| `sendCampaignUpdate(params)` | Send campaign newsletter | `Promise<any>` |

### Netlify Function Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/.netlify/functions/beehiv-sync/webhook` | POST | Receive Beehiv webhooks |
| `/.netlify/functions/beehiv-sync/send-campaign` | POST | Send newsletter campaign |
| `/.netlify/functions/beehiv-sync/stats` | GET | Get newsletter stats |
| `/.netlify/functions/beehiv-sync/publication` | GET | Get publication details |

### Next.js API Routes

| Route | Method | Purpose |
|-------|--------|---------|
| `/api/beehiv/subscribe` | POST | Subscribe user to newsletter |

---

## Error Handling

All API calls include error handling:

```typescript
try {
  await client.subscribe({ email: 'user@example.com' });
} catch (error) {
  if (error.message.includes('409')) {
    // Subscriber already exists
  } else if (error.message.includes('400')) {
    // Invalid request
  } else {
    // Network or API error
  }
}
```

---

## Testing

### Manual Testing

```bash
# Test subscription endpoint
curl -X POST https://yoursite.com/api/beehiv/subscribe \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com"}'

# Test webhook (local)
curl -X POST http://localhost:8888/.netlify/functions/beehiv-sync/webhook \
  -H "Content-Type: application/json" \
  -d '{"data":{"email":"test@example.com","publication_id":"pub_123","status":"active","created":1698765432}}'
```

### Unit Tests

```typescript
import { BeehivClient } from '@/lib/beehiv';

describe('BeehivClient', () => {
  it('should subscribe a user', async () => {
    const client = new BeehivClient('test_key', 'test_pub');
    // Mock fetch and test
  });
});
```

---

## Security Considerations

1. **API Key Protection**: Store `BEEHIV_API_KEY` in environment variables only
2. **Webhook Verification**: Implement HMAC signature verification for webhooks
3. **Rate Limiting**: Beehiv API has rate limits - implement retry logic
4. **Email Validation**: Always validate email format before API calls
5. **CORS**: Configured for cross-origin requests on public endpoints

---

## Monitoring

### Key Metrics

- Subscriber growth rate
- Newsletter open rate
- Click-through rate
- Campaign distribution success rate
- API error rate

### Logging

All operations log to console with structured format:

```typescript
console.log('[Beehiv]', 'Subscribed:', email);
console.error('[Beehiv Error]', error.message);
```

---

## Roadmap

### v1.1 - Enhanced Analytics
- [ ] Track individual subscriber engagement
- [ ] A/B test subject lines
- [ ] Segment-based campaigns

### v1.2 - Automation
- [ ] Auto-send weekly digest
- [ ] Trigger-based campaigns (sentiment shifts)
- [ ] Drip campaign sequences

### v1.3 - Advanced Integration
- [ ] Integrate with Budget Adapter for email ad spend
- [ ] Viral coefficient tracking for newsletter referrals
- [ ] Predictive send-time optimization

---

## Resources

- [Beehiv API Documentation](https://developers.beehiiv.com/docs/v2)
- [Beehiv Webhooks Guide](https://developers.beehiiv.com/docs/v2/webhooks)
- Internal: `src/lib/beehiv.ts` - Client implementation
- Internal: `netlify/functions/beehiv-sync.ts` - Webhook handler

---

**Status**: Active
**Maintainer**: Beehive Platform Team
**Last Review**: 2025-10-30

> The swarm extends its reach through newsletters. Every subscriber is a node in the network, amplifying the message with each share.
